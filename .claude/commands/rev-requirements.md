# 逆エンジニアリング 要件抽出コマンド

あなたは逆エンジニアリングの専門家です。既存のコードベースを分析して、要件定義書を逆生成してください。

## 逆エンジニアリングの目的

1. **既存システムの理解促進**
   - レガシコードの仕様把握
   - ドキュメント不備の補完
   - 改修・拡張時の影響範囲把握

2. **要件の再構築**
   - ビジネスロジックから要件を推定
   - ユーザーインターフェースから使用方法を分析
   - データフローから機能連携を理解

## 実行手順

1. **コードベース分析**
   - ディレクトリ構造の把握
   - 主要なクラス・関数の特定
   - データモデルの理解

2. **機能分析**
   - API エンドポイントの分析
   - UI コンポーネントの動作分析
   - ビジネスロジックの抽出

3. **要件推定**
   - 実装されている機能から要件を逆算
   - エラーハンドリングから制約要件を推定
   - テストコードから仕様を理解

4. **EARS記法での要件整理**
   - 推定された要件をEARS記法で整理
   - 確信度レベルを付与

## 分析対象

### ファイルタイプ別分析
```markdown
- **Controller/Router**: REST API エンドポイント → 機能要件
- **Service/Business Logic**: ビジネスルール → 業務要件
- **Model/Entity**: データ構造 → データ要件
- **Component/View**: UI動作 → ユーザー要件
- **Test Files**: テストケース → 受け入れ基準
- **Config Files**: 設定項目 → 非機能要件
```

### 重点分析項目
1. **入力検証ロジック** → 制約要件
2. **認証・認可処理** → セキュリティ要件
3. **エラーハンドリング** → 例外処理要件
4. **パフォーマンス処理** → 性能要件
5. **外部API連携** → 統合要件

## 出力構造

要件抽出レポートを以下のパスに保存：
`/Users/$(whoami)/Documents/claude-outputs/$(date +%Y-%m-%d)/[システム名]-逆要件定義書.md`

```markdown
# [システム名] 逆エンジニアリング要件定義書

## 分析概要
- **対象システム**: [システム名]
- **分析日**: [日付]
- **分析範囲**: [対象ディレクトリ・ファイル]
- **確信度**: 🟢高確信 / 🟡中確信 / 🔴低確信（要検証）

## コードベース構造分析
### ディレクトリ構造
[主要ディレクトリの役割]

### 主要コンポーネント
[核となるクラス・モジュールの分析]

## 推定要件（EARS記法）

### 通常要件（SHALL）- 実装済み機能
システムは[分析で特定した機能]を提供しなければならない。
**確信度**: 🟢 **根拠**: [具体的なコード箇所]

### 条件要件（WHEN/IF-THEN）- 条件分岐から推定
[条件]の場合、システムは[動作]しなければならない。
**確信度**: 🟡 **根拠**: [条件分岐ロジック]

### 制約要件（MUST）- バリデーション・制限から推定
システムは[制約]に従わなければならない。
**確信度**: 🟢 **根拠**: [バリデーションコード]

### オプション要件（MAY）- 設定可能機能から推定
システムは[機能]を提供してもよい。
**確信度**: 🔴 **根拠**: [設定項目・フラグ]

## 機能要件分析

### 特定済み機能
1. **[機能名]**: [機能説明]
   - **実装箇所**: [ファイルパス:行数]
   - **動作**: [具体的な処理内容]
   - **確信度**: 🟢

### 推定機能
1. **[推定機能名]**: [推定根拠]
   - **推定根拠**: [コード断片・設計パターン]
   - **確信度**: 🟡

## 非機能要件分析

### セキュリティ要件
- **認証方式**: [実装されている認証方法]
- **認可制御**: [権限管理の仕組み]
- **データ保護**: [暗号化・マスキング処理]

### パフォーマンス要件
- **応答時間**: [タイムアウト設定から推定]
- **同時接続**: [接続プール設定から推定]
- **データ処理**: [バッチ処理・ページング実装]

### 可用性要件
- **エラーハンドリング**: [例外処理パターン]
- **ログ出力**: [ログレベル・出力内容]
- **リトライ処理**: [再試行ロジック]

## データ要件分析

### データモデル
[Entity・Model クラスから推定されるデータ構造]

### データフロー
[Controller → Service → Repository の流れ]

### データ制約
[バリデーションルール・データベース制約]

## 不明点・要検証項目

### 高優先度（🔴）
1. **[不明項目]**: [なぜ不明か・調査方法]

### 中優先度（🟡）
1. **[推定項目]**: [確認が必要な理由]

## 改善提案

### ドキュメント不足
- **要件定義書**: [必要性・優先度]
- **API仕様書**: [エンドポイント仕様の明文化]
- **設計書**: [アーキテクチャの文書化]

### コード改善
- **コメント不足**: [要説明箇所]
- **テスト不足**: [未テスト機能]
- **リファクタリング**: [改善提案]

## 次のステップ

1. **要検証項目の確認**: ステークホルダーへのヒアリング
2. **ドキュメント作成**: `/kairo-design` で設計書生成
3. **テスト追加**: 推定要件の検証テスト作成
4. **リファクタリング**: `/refactor` で改善実施
```

## 分析パターン

### APIエンドポイント分析
```typescript
// 例: Express.js ルート分析
app.post('/api/users', (req, res) => {
  // → "ユーザー作成機能が必要" (SHALL要件)
  // → 入力検証から制約要件を推定
});
```

### ビジネスロジック分析
```typescript
// 例: 条件分岐分析
if (user.role === 'admin') {
  // → "管理者権限による条件要件" (WHEN-THEN要件)
}
```

### 設定ファイル分析
```json
// 例: 設定から非機能要件を推定
{
  "timeout": 30000,  // → 応答時間要件
  "maxConnections": 100  // → 同期接続要件
}
```

## 実行方法

```bash
# 使用例
/rev-requirements ./src
/rev-requirements ./api --format markdown
/rev-requirements . --confidence high
```

## 確信度レベル
- 🟢 **高確信**: コードから明確に読み取れる
- 🟡 **中確信**: 推測可能だが確認が必要
- 🔴 **低確信**: 不明・要検証

コードベースのパスを指定してください。既存コードから要件定義を逆生成します。